
# Reference: <https://postmarketos.org/vendorkernel>
# Kernel config based on: arch/arm64/configs/(CHANGEME!)
export CARCH=aarch64 
#export SUDO_APK='abuild-apk --no-progress' 
export CROSS_COMPILE=aarch64-alpine-linux-musl- 
export CC=aarch64-alpine-linux-musl-gcc 
export RUSTC_WRAPPER=/usr/bin/sccache 
export GOCACHE=/home/pmos/.cache/go-build 
export HOME=/home/pmos
export LITTLE_CPU_MASK=yes


pkgname=linux-xiaomi-mojito
pkgver=4.14.190
pkgrel=3
pkgdesc="Xiaomi Redmi Note 10 kernel fork"
arch="aarch64"
_carch="arm64"
_flavor="xiaomi-mojito"
url="https://kernel.org"
license="GPL-2.0-only"
options="!strip !check !tracedeps pmb:cross-native"
makedepends="
	bash
	bc
	bison
	devicepkg-dev
	findutils
	flex
	openssl-dev
	linux-headers
	nano
	ncurses
	ncurses-dev
	perl
	xz
	ccache-cross-symlinks 
	abuild 
	gcc-aarch64 
	g++-aarch64
	mpc1-dev
"

# Source
_repository="linux-xiaomi-mojito"
_commit="android_kernel_xiaomi_mojito"
_config="config-$_flavor.$arch"
source="
	$pkgname-$_commit.tar::http://127.0.0.1/$_commit.tar
	$_config


"
#src/linux-xiaomi-mojito/765eaec61cf526fabdfe52cdea1ef6aa9415b993/

builddir="$srcdir/$_commit"
_outdir="../$srcdir/out"
#export defconfig = $builddir/arch/arm64/configs/mojito_defconfig
prepare() {
	default_prepare
	. downstreamkernel_prepare
}

build() {
	unset LDFLAGS
	#make clean
	#make mrproper
	#cp /home/pmos/build/config-xiaomi-mojito.aarch64 /home/pmos/build/src/android_kernel_xiaomi_mojito/.config
	#mkdir -p /home/pmos/build/src/linux-xiaomi-mojito/android_kernel_xiaomi_sm6150/include/linux/
	rm -rf  /home/pmos/build/src/$_commit/include/linux/compiler-gcc.h
	cp /home/pmos/build/compiler-gcc.h /home/pmos/build/src/$_commit/include/linux/compiler-gcc.h
	#mkdir -p /home/pmos/build/src/xiaomi_kernel_opensource/kernel/
	#rm -rf $builddir/kernel/sched
	#mkdir -p /home/pmos/build/src/xiaomi_kernel_opensource/kernel/
	#tar xvf /home/pmos/build/sched.tar -C $builddir/kernel/
	#rm -rf $builddir/crypto/shash.c
	#cp /home/pmos/build/shash.c $builddir/crypto/shash.c
	mkdir -p /home/pmos/build/src/home/pmos/build/src/out/arch/arm64/boot
	cp /home/pmos/build/Image /home/pmos/build/src/home/pmos/build/src/out/arch/arm64/boot
	cp /home/pmos/build/Image /home/pmos/build/src/home/pmos/build/src/out/arch/arm64/boot/zImage
	#cp /home/pmos/build/vmlinux /home/pmos/build/src/home/pmos/build/src/out/arch/arm64/boot

	make  O="$_outdir" CONFIG_LITTLE_CPU_MASK=63 ARCH="$_carch" CC="${CC:-gcc}" \
		KBUILD_BUILD_VERSION="$((pkgrel + 1 ))-postmarketOS"
}

package() {
	downstreamkernel_package "$builddir" "$pkgdir" "$_carch" \
		"$_flavor" "$_outdir"
}

sha512sums="
33f5f337a774d6daf2fb3dba82997caa4f9adc9b308024f808de5108b34dbf2d0142a0d6e8030f90fdf9ecfc845ef1b634e0fc8a92040a4ffe55759cca5f5b52  linux-xiaomi-mojito-$_commit.tar
2596f9c102d8409c91b28db2c3ed29acd900633104bde804065f55cf60e7b6c744fc2870b5a3ced2e491062be5fe65cc82be11a48dda85846767ce3d35451ff2  $_config

"
